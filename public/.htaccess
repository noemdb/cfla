<IfModule mod_negotiation.c>
    Options -MultiViews -Indexes
</IfModule>

<IfModule mod_rewrite.c>
    RewriteEngine On
    
    # =================================================================
    # BLOQUEO DE BACKDOORS - REGLAS MEJORADAS
    # =================================================================
    
    # REGLA 1: Bloquear parámetros específicos sin importar valor
    RewriteCond %{QUERY_STRING} (^|&)img=[^&]* [NC,OR]
    RewriteCond %{QUERY_STRING} (^|&)download=[^&]* [NC,OR]
    RewriteCond %{QUERY_STRING} (^|&)zip=[^&]* [NC,OR]
    RewriteCond %{QUERY_STRING} (^|&)wanna_play_with_me=[^&]* [NC]
    RewriteRule .* - [F,L]
    
    # REGLA 2: Bloquear funciones peligrosas
    RewriteCond %{QUERY_STRING} base64_decode [NC,OR]
    RewriteCond %{QUERY_STRING} (shell_exec|passthru|exec|system) [NC,OR]
    RewriteCond %{QUERY_STRING} phpinfo [NC,OR]
    RewriteCond %{QUERY_STRING} (cmd=|eval\(|union.*select) [NC]
    RewriteRule .* - [F,L]
    
    # REGLA 3: Bloquear archivos maliciosos conocidos
    RewriteCond %{REQUEST_URI} (filemanagerNew|Enterprise-FM|bootstrap\.cache)\.php [NC]
    RewriteRule .* - [F,L]
    
    # REGLA 4: Bloquear parámetros en cualquier posición
    RewriteCond %{QUERY_STRING} .*img.* [NC]
    RewriteCond %{QUERY_STRING} !(jpeg|jpg|png|gif|webp) [NC]
    RewriteRule .* - [F,L]

    # =================================================================
    # CONFIGURACIÓN ORIGINAL LARAVEL (modificada)
    # =================================================================
    
    # Desactivar listado de directorios
    Options -Indexes
    
    # Bloquear ejecución de PHP fuera de index.php
    <FilesMatch "\.(php|phtml|php5|php7|phar)$">
        <IfModule mod_authz_core.c>
            Require all denied
        </IfModule>
        <IfModule !mod_authz_core.c>
            Order deny,allow
            Deny from all
        </IfModule>
    </FilesMatch>

    <Files "index.php">
        <IfModule mod_authz_core.c>
            Require all granted
        </IfModule>
    </Files>

    # Bloquear extensiones usadas para malware
    <FilesMatch "\.(wbmp|fla|dat|log|sh)$">
        Require all denied
    </FilesMatch>

    # Manejo Authorization Header
    RewriteCond %{HTTP:Authorization} .
    RewriteRule .* - [E=HTTP_AUTHORIZATION:%{HTTP:Authorization}]

    # Redirección de trailing slash
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteCond %{REQUEST_URI} (.+)/$
    RewriteRule ^ %1 [L,R=301]

    # Front Controller Laravel
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteRule ^ index.php [L]
</IfModule>
